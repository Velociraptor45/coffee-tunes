@using CoffeeTunes.Contracts.BrewCycles
@using CoffeeTunes.Contracts

<div class="results-display">
    <h3 class="results-title">‚òï Brewing Results</h3>
    
    <div class="video-name-section">
        <h4 class="video-name-title">üéµ Video:</h4>
        <p class="video-name">@VideoName</p>
    </div>
    
    <div class="owners-section">
        <h4 class="section-title">üë§ Submitted by:</h4>
        <div class="owners-list">
            @foreach (var owner in Results.Owners)
            {
                <div class="owner-item">
                    <span class="owner-icon">üë§</span>
                    <span class="owner-name">@owner.Name</span>
                </div>
            }
        </div>
    </div>
    
    <div class="votes-section">
        <h4 class="section-title">üó≥Ô∏è Voting Results:</h4>
        <div class="votes-chart">
            @foreach (var barData in GetBarChartData())
            {
                var isCorrectOwner = ownerIds.Contains(barData.HipsterId);
                <div class="vote-bar @(isCorrectOwner ? "correct-owner" : "")">
                    <div class="bar-header">
                        <span class="bar-icon">üë§</span>
                        <span class="bar-name">@barData.HipsterName</span>
                        <span class="bar-vote-count">@barData.VoteCount vote@(barData.VoteCount == 1 ? "" : "s")</span>
                        @if (isCorrectOwner)
                        {
                            <span class="correct-badge">‚úì CORRECT</span>
                        }
                    </div>
                    
                    @if (barData.VoteCount > 0)
                    {
                        <div class="bar-visual">
                            <div class="bar-fill" style="width: @GetBarWidth(barData.VoteCount)%"></div>
                        </div>
                        
                        <div class="bar-voters">
                            <span class="voters-label">Voted by:</span>
                            @foreach (var voter in barData.Voters)
                            {
                                <span class="voter-chip">@voter</span>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="no-votes">No votes received</div>
                    }
                </div>
            }
        </div>
    </div>
    
    <div class="brew-cycle-actions">
        <button 
            class="next-ingredient-button" 
            @onclick="HandleNextIngredient"
            disabled="@isProcessing">
            @if (isProcessing && processingAction == "next")
            {
                <span class="button-spinner">‚è≥</span>
                <span>Loading...</span>
            }
            else
            {
                <span class="button-icon">‚û°Ô∏è</span>
                <span>Next Ingredient</span>
            }
        </button>
        
        <button 
            class="end-brew-cycle-button" 
            @onclick="HandleEndBrewCycle"
            disabled="@isProcessing">
            @if (isProcessing && processingAction == "end")
            {
                <span class="button-spinner">‚è≥</span>
                <span>Ending...</span>
            }
            else
            {
                <span class="button-icon">üèÅ</span>
                <span>End Brew Cycle</span>
            }
        </button>
    </div>
</div>

@code {
    [Parameter]
    public required BrewCycleRevealContract Results { get; set; }
    
    [Parameter]
    public required string VideoName { get; set; }
    
    [Parameter]
    public required Guid FranchiseId { get; set; }
    
    [Parameter]
    public required Guid BarId { get; set; }
    
    [Inject]
    public ICoffeeTunesApi Api { get; set; } = default!;
    
    private HashSet<Guid> ownerIds = new();
    private int maxVotes = 0;
    private bool isProcessing = false;
    private string processingAction = "";
    
    protected override void OnParametersSet()
    {
        ownerIds = Results.Owners.Select(o => o.HipsterId).ToHashSet();
        
        // Calculate max votes for bar chart scaling
        var voteCounts = GetBarChartData().Select(b => b.VoteCount).ToList();
        maxVotes = voteCounts.Any() ? voteCounts.Max() : 1;
    }
    
    private async Task HandleNextIngredient()
    {
        isProcessing = true;
        processingAction = "next";
        try
        {
            await Api.NextIngredient(FranchiseId, BarId);
        }
        catch (Exception ex)
        {
            await Console.Error.WriteLineAsync($"Error advancing to next ingredient: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
            processingAction = "";
        }
    }
    
    private async Task HandleEndBrewCycle()
    {
        isProcessing = true;
        processingAction = "end";
        try
        {
            await Api.EndBrewCycle(FranchiseId, BarId);
        }
        catch (Exception ex)
        {
            await Console.Error.WriteLineAsync($"Error ending brew cycle: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
            processingAction = "";
        }
    }
    
    private class BarChartData
    {
        public required Guid HipsterId { get; set; }
        public required string HipsterName { get; set; }
        public required int VoteCount { get; set; }
        public required List<string> Voters { get; set; }
    }
    
    private List<BarChartData> GetBarChartData()
    {
        // Group all votes by the hipster who received them
        var votesByRecipient = new Dictionary<Guid, List<string>>();
        var hipsterNames = new Dictionary<Guid, string>();
        
        // Process all beans to see who voted for whom
        foreach (var result in Results.Results)
        {
            foreach (var bean in result.Beans)
            {
                var recipientId = bean.HipsterCastFor.HipsterId;
                var voterName = result.Hipster.Name;
                
                if (!votesByRecipient.ContainsKey(recipientId))
                {
                    votesByRecipient[recipientId] = new List<string>();
                }
                votesByRecipient[recipientId].Add(voterName);
                hipsterNames[recipientId] = bean.HipsterCastFor.Name;
            }
        }
        
        // Also include hipsters who received no votes
        foreach (var result in Results.Results)
        {
            var hipsterId = result.Hipster.HipsterId;
            if (!votesByRecipient.ContainsKey(hipsterId))
            {
                votesByRecipient[hipsterId] = new List<string>();
                hipsterNames[hipsterId] = result.Hipster.Name;
            }
        }
        
        // Create bar chart data and sort: descending by vote count, then alphabetically
        return votesByRecipient
            .Select(kvp => new BarChartData
            {
                HipsterId = kvp.Key,
                HipsterName = hipsterNames[kvp.Key],
                VoteCount = kvp.Value.Count,
                Voters = kvp.Value.OrderBy(v => v).ToList()
            })
            .OrderByDescending(b => b.VoteCount)
            .ThenBy(b => b.HipsterName)
            .ToList();
    }
    
    private string GetBarWidth(int voteCount)
    {
        if (maxVotes == 0) return "0";
        return ((voteCount * 100.0) / maxVotes).ToString("F1");
    }
}
