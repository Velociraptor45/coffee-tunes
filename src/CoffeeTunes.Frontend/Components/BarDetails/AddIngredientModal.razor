@using CoffeeTunes.Contracts
@using CoffeeTunes.Contracts.Bars
@using CoffeeTunes.Contracts.Ingredients

@if (IsVisible)
{
    <div class="modal-overlay" @onclick="Close">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>☕ Add Ingredient</h2>
                <button class="modal-close" @onclick="Close">✕</button>
            </div>
            <div class="modal-body">
                <p class="modal-description">
                    Add a YouTube video to @Bar.Topic. Make sure it fits the theme!
                </p>
                <div class="form-group">
                    <label for="youtube-url">YouTube URL</label>
                    <input
                        id="youtube-url"
                        type="text"
                        class="form-input @(showError ? "error" : "")"
                        placeholder="https://www.youtube.com/watch?v=..."
                        @bind="youtubeUrl"
                        @bind:event="oninput"
                        disabled="@isSubmitting" />
                    @if (showError && !string.IsNullOrWhiteSpace(errorMessage))
                    {
                        <div class="error-message">@errorMessage</div>
                    }
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-button secondary" @onclick="Close" disabled="@isSubmitting">
                    Cancel
                </button>
                <button class="modal-button primary" @onclick="Submit" disabled="@(isSubmitting || string.IsNullOrWhiteSpace(youtubeUrl))">
                    @if (isSubmitting)
                    {
                        <span class="button-spinner">☕</span>
                        <span>Adding...</span>
                    }
                    else
                    {
                        <span>Add Ingredient</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public required bool IsVisible { get; set; }

    [Parameter]
    public required BarContract Bar { get; set; }

    [Parameter]
    public required Guid FranchiseId { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    [Parameter]
    public EventCallback OnIngredientAdded { get; set; }

    [Inject]
    public ICoffeeTunesApi Api { get; set; } = default!;

    private string youtubeUrl = string.Empty;
    private bool isSubmitting = false;
    private bool showError = false;
    private string? errorMessage;

    private void Close()
    {
        if (!isSubmitting)
        {
            youtubeUrl = string.Empty;
            showError = false;
            errorMessage = null;
            OnClose.InvokeAsync();
        }
    }

    private async Task Submit()
    {
        if (string.IsNullOrWhiteSpace(youtubeUrl))
        {
            return;
        }

        isSubmitting = true;
        showError = false;
        errorMessage = null;

        try
        {
            var contract = new AddIngredientContract
            {
                Url = youtubeUrl.Trim()
            };

            await Api.AddIngredient(FranchiseId, Bar.Id, contract);
            youtubeUrl = string.Empty;
            await OnIngredientAdded.InvokeAsync();
        }
        catch (HttpRequestException)
        {
            showError = true;
            errorMessage = "Unable to connect to the server. Please check your connection and try again.";
        }
        catch (Exception ex)
        {
            showError = true;
            errorMessage = "Unable to add ingredient. Please try again later.";
            await Console.Error.WriteLineAsync($"Error adding ingredient: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
        }
    }
}
