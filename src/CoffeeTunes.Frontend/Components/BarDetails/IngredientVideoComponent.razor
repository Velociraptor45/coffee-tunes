@using CoffeeTunes.Contracts.BrewCycles
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<div class="ingredient-display">
    <h3 class="ingredient-title">@Ingredient.Name</h3>
    <div class="ingredient-video">
        <div id="@playerId"></div>
    </div>
    <div class="ingredient-link">
        <a href="@Ingredient.Url" target="_blank" rel="noopener noreferrer" class="watch-link">
            <span>ðŸŽ¥</span>
            <span>Watch on YouTube</span>
        </a>
    </div>
</div>

@code {
    [Parameter]
    public required BrewCycleIngredientContract Ingredient { get; set; }
    
    [Parameter]
    public required Guid FranchiseId { get; set; }
    
    [Parameter]
    public required Guid BarId { get; set; }
    
    [Parameter]
    public EventCallback<(Guid franchiseId, Guid barId)> OnVideoPlayed { get; set; }
    
    [Parameter]
    public EventCallback<(Guid franchiseId, Guid barId)> OnVideoPaused { get; set; }
    
    private string playerId = $"youtube-player-{Guid.NewGuid()}";
    private DotNetObjectReference<IngredientVideoComponent>? dotNetHelper;
    private bool isPlayerInitialized = false;
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Console.WriteLine("Executing first render...");
            try
            {
                var videoId = GetVideoId(Ingredient.Url);
                if (!string.IsNullOrEmpty(videoId))
                {
                    Console.WriteLine($"Creating video frame for id {videoId}");
                    dotNetHelper = DotNetObjectReference.Create(this);
                    await JSRuntime.InvokeVoidAsync("youtubePlayerModule.createPlayer", 
                        playerId, videoId, dotNetHelper, FranchiseId.ToString(), BarId.ToString());
                    Console.WriteLine("Player initialization finished.");
                    isPlayerInitialized = true;
                }
            }
            catch (Exception ex)
            {
                await Console.Error.WriteLineAsync($"Error initializing YouTube player: {ex.Message}");
            }
        }
    }
    
    [JSInvokable]
    public async Task OnVideoPlayedFromJs(string franchiseId, string barId)
    {
        if (Guid.TryParse(franchiseId, out var fId) && Guid.TryParse(barId, out var bId))
        {
            await OnVideoPlayed.InvokeAsync((fId, bId));
        }
    }
    
    [JSInvokable]
    public async Task OnVideoPausedFromJs(string franchiseId, string barId)
    {
        if (Guid.TryParse(franchiseId, out var fId) && Guid.TryParse(barId, out var bId))
        {
            await OnVideoPaused.InvokeAsync((fId, bId));
        }
    }
    
    public async Task PlayVideo()
    {
        if (isPlayerInitialized)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("youtubePlayerModule.playVideo", playerId);
            }
            catch (Exception ex)
            {
                await Console.Error.WriteLineAsync($"Error playing video: {ex.Message}");
            }
        }
    }
    
    public async Task PauseVideo()
    {
        if (isPlayerInitialized)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("youtubePlayerModule.pauseVideo", playerId);
            }
            catch (Exception ex)
            {
                await Console.Error.WriteLineAsync($"Error pausing video: {ex.Message}");
            }
        }
    }
    
    private string GetVideoId(string youtubeUrl)
    {
        try
        {
            // Extract video ID from YouTube URL
            // https://www.youtube.com/watch?v=VIDEO_ID -> VIDEO_ID
            var uri = new Uri(youtubeUrl);
            
            // Parse query string manually for Blazor WebAssembly compatibility
            var query = uri.Query.TrimStart('?');
            var videoId = query.Split('&')
                .Select(param => param.Split('='))
                .Where(parts => parts.Length == 2 && parts[0] == "v")
                .Select(parts => parts[1])
                .FirstOrDefault();
                
            return videoId ?? string.Empty;
        }
        catch
        {
            return string.Empty;
        }
    }
    
    public async ValueTask DisposeAsync()
    {
        if (isPlayerInitialized)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("youtubePlayerModule.disposePlayer", playerId);
            }
            catch (Exception ex)
            {
                await Console.Error.WriteLineAsync($"Error disposing YouTube player: {ex.Message}");
            }
        }
        
        dotNetHelper?.Dispose();
    }
}
