@using CoffeeTunes.Contracts
@using CoffeeTunes.Contracts.Bars
@using CoffeeTunes.Contracts.BrewCycles

@if (BrewCycle == null)
{
    <div class="brewing-empty-state">
        <div class="brewing-icon">‚òï</div>
        @if (!Bar.IsOpen && Bar.HasSupplyLeft)
        {
            <h2>Ready to Brew!</h2>
            <p>Click the button below to start a brewing cycle and see who submitted this ingredient.</p>
            <button class="start-brew-button" @onclick="StartBrewCycle" disabled="@isStarting">
                @if (isStarting)
                {
                    <span class="button-spinner">‚è≥</span>
                    <span>Starting...</span>
                }
                else
                {
                    <span class="button-icon">üî•</span>
                    <span>Start Brewing</span>
                }
            </button>
        }
        else if (Bar.IsOpen)
        {
            <h2>Brewing in Progress</h2>
            <p>The bar is currently open. Waiting for the next ingredient...</p>
        }
        else if (!Bar.HasSupplyLeft)
        {
            <h2>Out of Supply</h2>
            <p>There are no more ingredients to brew.</p>
        }
    </div>
}
else
{
    <div class="brewing-active">
        <div class="brewing-header">
            <h2>üî• Now Brewing</h2>
            <span class="brewing-badge">ACTIVE</span>
        </div>
        
        <div class="brewing-content">
            <div class="brewing-left">
                @if (RevealResults == null)
                {
                    <IngredientVideoComponent 
                        @ref="videoPlayerComponent"
                        Ingredient="@BrewCycle.Ingredient"
                        FranchiseId="@FranchiseId"
                        BarId="@BarId"
                        OnVideoPlayed="@HandleVideoPlayed"
                        OnVideoPaused="@HandleVideoPaused" />
                }
                else
                {
                    <BrewCycleResultsComponent 
                        Results="@RevealResults" 
                        VideoName="@BrewCycle.Ingredient.Name"
                        FranchiseId="@FranchiseId"
                        BarId="@BarId"
                        Bar="@Bar" />
                }
            </div>
            
            <div class="brewing-right">
                <div class="right-upper">
                    <VotingPanel 
                        Bar="@Bar"
                        FranchiseId="@FranchiseId"
                        BarId="@BarId"
                        BrewCycle="@BrewCycle"
                        HasCurrentUserVoted="@(CurrentUserId.HasValue && VotedHipsterIds.Contains(CurrentUserId.Value))"
                        IsRevealed="@(RevealResults != null)" />
                </div>
                <div class="right-lower">
                    <VotersList 
                        JoinedHipsters="@JoinedHipsters"
                        VotedHipsterIds="@VotedHipsterIds"
                        FranchiseId="@FranchiseId"
                        BarId="@BarId"
                        IsRevealed="@(RevealResults != null)" />
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public required BarContract Bar { get; set; }
    
    [Parameter]
    public required Guid FranchiseId { get; set; }
    
    [Parameter]
    public required Guid BarId { get; set; }
    
    [Parameter]
    public BrewCycleContract? BrewCycle { get; set; }
    
    [Parameter]
    public Dictionary<Guid, string> JoinedHipsters { get; set; } = new();
    
    [Parameter]
    public HashSet<Guid> VotedHipsterIds { get; set; } = new();
    
    [Parameter]
    public Guid? CurrentUserId { get; set; }
    
    [Parameter]
    public EventCallback OnBrewCycleStarted { get; set; }
    
    [Parameter]
    public BrewCycleRevealContract? RevealResults { get; set; }
    
    [Parameter]
    public EventCallback OnVideoPlaySignalReceived { get; set; }
    
    [Parameter]
    public EventCallback OnVideoPauseSignalReceived { get; set; }
    
    [Inject]
    public ICoffeeTunesApi Api { get; set; } = default!;
    
    private bool isStarting = false;
    private IngredientVideoComponent? videoPlayerComponent;
    
    private async Task StartBrewCycle()
    {
        isStarting = true;
        try
        {
            await Api.StartBrewCycle(FranchiseId, BarId);
            await OnBrewCycleStarted.InvokeAsync();
        }
        catch (Exception ex)
        {
            await Console.Error.WriteLineAsync($"Error starting brew cycle: {ex.Message}");
        }
        finally
        {
            isStarting = false;
        }
    }
    
    private async Task HandleVideoPlayed((Guid franchiseId, Guid barId) args)
    {
        try
        {
            await Api.StartPlayingVideo(args.franchiseId, args.barId);
        }
        catch (Exception ex)
        {
            await Console.Error.WriteLineAsync($"Error notifying video play: {ex.Message}");
        }
    }
    
    private async Task HandleVideoPaused((Guid franchiseId, Guid barId) args)
    {
        try
        {
            await Api.PausePlayingVideo(args.franchiseId, args.barId);
        }
        catch (Exception ex)
        {
            await Console.Error.WriteLineAsync($"Error notifying video pause: {ex.Message}");
        }
    }
    
    public async Task PlayVideo()
    {
        if (videoPlayerComponent != null)
        {
            await videoPlayerComponent.PlayVideo();
        }
    }
    
    public async Task PauseVideo()
    {
        if (videoPlayerComponent != null)
        {
            await videoPlayerComponent.PauseVideo();
        }
    }
}
