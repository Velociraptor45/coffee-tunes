@using CoffeeTunes.Contracts
@using CoffeeTunes.Contracts.Bars
@using CoffeeTunes.Contracts.BrewCycles

@if (BrewCycle == null)
{
    <div class="brewing-empty-state">
        <div class="brewing-icon">‚òï</div>
        @if (!Bar.IsOpen && Bar.HasSupplyLeft)
        {
            <h2>Ready to Brew!</h2>
            <p>Click the button below to start a brewing cycle and see who submitted this ingredient.</p>
            <button class="start-brew-button" @onclick="StartBrewCycle" disabled="@isStarting">
                @if (isStarting)
                {
                    <span class="button-spinner">‚è≥</span>
                    <span>Starting...</span>
                }
                else
                {
                    <span class="button-icon">üî•</span>
                    <span>Start Brewing</span>
                }
            </button>
        }
        else if (Bar.IsOpen)
        {
            <h2>Brewing in Progress</h2>
            <p>The bar is currently open. Waiting for the next ingredient...</p>
        }
        else if (!Bar.HasSupplyLeft)
        {
            <h2>Out of Supply</h2>
            <p>There are no more ingredients to brew. Add more ingredients to continue!</p>
        }
    </div>
}
else
{
    <div class="brewing-active">
        <div class="brewing-header">
            <h2>üî• Now Brewing</h2>
            <span class="brewing-badge">ACTIVE</span>
        </div>
        
        <div class="brewing-content">
            <div class="brewing-left">
                <div class="ingredient-display">
                    <h3 class="ingredient-title">@BrewCycle.Ingredient.Name</h3>
                    <div class="ingredient-video">
                        <iframe 
                            src="@GetEmbedUrl(BrewCycle.Ingredient.Url)" 
                            title="@BrewCycle.Ingredient.Name"
                            frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen>
                        </iframe>
                    </div>
                    <div class="ingredient-link">
                        <a href="@BrewCycle.Ingredient.Url" target="_blank" rel="noopener noreferrer" class="watch-link">
                            <span>üé•</span>
                            <span>Watch on YouTube</span>
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="brewing-right">
                <div class="right-upper">
                    <VotingPanel 
                        Bar="@Bar"
                        FranchiseId="@FranchiseId"
                        BarId="@BarId"
                        BrewCycle="@BrewCycle"
                        HasCurrentUserVoted="@(CurrentUserId.HasValue && VotedHipsterIds.Contains(CurrentUserId.Value))" />
                </div>
                <div class="right-lower">
                    <VotersList 
                        JoinedHipsters="@JoinedHipsters"
                        VotedHipsterIds="@VotedHipsterIds" />
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public required BarContract Bar { get; set; }
    
    [Parameter]
    public required Guid FranchiseId { get; set; }
    
    [Parameter]
    public required Guid BarId { get; set; }
    
    [Parameter]
    public BrewCycleContract? BrewCycle { get; set; }
    
    [Parameter]
    public Dictionary<Guid, string> JoinedHipsters { get; set; } = new();
    
    [Parameter]
    public HashSet<Guid> VotedHipsterIds { get; set; } = new();
    
    [Parameter]
    public Guid? CurrentUserId { get; set; }
    
    [Parameter]
    public EventCallback OnBrewCycleStarted { get; set; }
    
    [Inject]
    public ICoffeeTunesApi Api { get; set; } = default!;
    
    private bool isStarting = false;
    
    private async Task StartBrewCycle()
    {
        isStarting = true;
        try
        {
            await Api.StartBrewCycle(FranchiseId, BarId);
            await OnBrewCycleStarted.InvokeAsync();
        }
        catch (Exception ex)
        {
            await Console.Error.WriteLineAsync($"Error starting brew cycle: {ex.Message}");
        }
        finally
        {
            isStarting = false;
        }
    }
    
    private string GetEmbedUrl(string youtubeUrl)
    {
        try
        {
            // Convert YouTube watch URL to embed URL
            // https://www.youtube.com/watch?v=VIDEO_ID -> https://www.youtube.com/embed/VIDEO_ID
            var uri = new Uri(youtubeUrl);
            
            // Parse query string manually for Blazor WebAssembly compatibility
            var query = uri.Query.TrimStart('?');
            var videoId = query.Split('&')
                .Select(param => param.Split('='))
                .Where(parts => parts.Length == 2 && parts[0] == "v")
                .Select(parts => parts[1])
                .FirstOrDefault();
                
            if (string.IsNullOrEmpty(videoId))
            {
                // If no video ID found, return original URL
                return youtubeUrl;
            }
            
            return $"https://www.youtube.com/embed/{videoId}";
        }
        catch
        {
            // If URL parsing fails, return original URL
            return youtubeUrl;
        }
    }
}
