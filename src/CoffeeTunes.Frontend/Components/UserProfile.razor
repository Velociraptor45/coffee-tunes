@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using CoffeeTunes.Frontend.Configs
@using CoffeeTunes.Contracts
@inject NavigationManager Navigation
@inject AuthConfig AuthConfig
@inject ICoffeeTunesApi Api

<AuthorizeView>
    <Authorized>
        <div class="user-profile">
            <div class="user-name" @onclick="ToggleDropdown">
                <span class="user-icon">üë§</span>
                <span>@GetUserName(context)</span>
                <span class="dropdown-arrow">‚ñº</span>
            </div>
            @if (showDropdown)
            {
                <div class="user-dropdown">
                    <button class="dropdown-item delete-account-button" @onclick="ShowDeleteAccountConfirmation">
                        <span class="item-icon">üóëÔ∏è</span>
                        <span>Delete Account</span>
                    </button>
                    <button class="dropdown-item logout-button" @onclick="BeginLogout">
                        <span class="item-icon">üö™</span>
                        <span>Logout</span>
                    </button>
                </div>
            }
        </div>

        <ConfirmationModal 
            IsVisible="@showDeleteAccountModal"
            Title="Delete Account"
            Message="Are you sure you want to delete your account? This action cannot be undone. All your data, including franchises you own, will be permanently deleted."
            ConfirmText="Delete Account"
            ProcessingText="Deleting..."
            OnConfirm="@HandleDeleteAccount"
            OnCancel="@CloseDeleteAccountModal" />
    </Authorized>
</AuthorizeView>

@code {
    private bool showDropdown = false;
    private bool showDeleteAccountModal = false;
    private Guid? currentUserId;

    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadUserInfo();
    }

    private async Task LoadUserInfo()
    {
        if (AuthenticationStateTask != null)
        {
            var authState = await AuthenticationStateTask;
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var subClaim = user.FindFirst("sub");
                if (subClaim != null && Guid.TryParse(subClaim.Value, out var userId))
                {
                    currentUserId = userId;
                }
            }
        }
    }

    private void ToggleDropdown()
    {
        showDropdown = !showDropdown;
    }

    private string GetUserName(AuthenticationState state)
    {
        var nameClaim = state.User.FindFirst(AuthConfig.NameClaimIdentifier);
        return nameClaim?.Value ?? "User";
    }

    private void BeginLogout()
    {
        Navigation.NavigateToLogout("authentication/logout");
    }

    private void ShowDeleteAccountConfirmation()
    {
        showDropdown = false;
        showDeleteAccountModal = true;
    }

    private void CloseDeleteAccountModal()
    {
        showDeleteAccountModal = false;
    }

    private async Task HandleDeleteAccount()
    {
        if (!currentUserId.HasValue)
        {
            await Console.Error.WriteLineAsync("Cannot delete account: User ID not found");
            showDeleteAccountModal = false;
            return;
        }

        try
        {
            await Api.DeleteAccount(currentUserId.Value);
            // After successful deletion, log the user out
            Navigation.NavigateToLogout("authentication/logout");
        }
        catch (Exception ex)
        {
            await Console.Error.WriteLineAsync($"Error deleting account: {ex.Message}");
        }
        finally
        {
            showDeleteAccountModal = false;
        }
    }
}
