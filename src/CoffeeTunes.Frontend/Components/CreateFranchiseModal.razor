@using CoffeeTunes.Contracts
@using CoffeeTunes.Contracts.Franchise

<div class="modal-backdrop @(IsVisible ? "show" : "")" @onclick="OnBackdropClick">
    <div class="modal-content" @onclick:stopPropagation="true">
        <div class="modal-header">
            <h2 class="modal-title">☕ Create New Franchise</h2>
            <button class="modal-close" @onclick="Close">✕</button>
        </div>
        
        @if (errorMessage != null)
        {
            <div class="modal-error">
                <div class="error-icon">⚠️</div>
                <p>@errorMessage</p>
            </div>
        }

        <div class="modal-body">
            <form @onsubmit="HandleSubmit">
                <div class="form-group">
                    <label for="franchise-name">Franchise Name</label>
                    <input 
                        id="franchise-name"
                        type="text" 
                        class="form-input" 
                        @bind="franchiseName" 
                        placeholder="Enter your coffee franchise name..."
                        maxlength="100"
                        disabled="@isSubmitting"
                        required />
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" @onclick="Close" disabled="@isSubmitting">
                        Cancel
                    </button>
                    <button type="submit" class="btn-create" disabled="@(isSubmitting || string.IsNullOrWhiteSpace(franchiseName))">
                        @if (isSubmitting)
                        {
                            <span class="spinner">☕</span>
                            <span>Creating...</span>
                        }
                        else
                        {
                            <span>Create Franchise</span>
                        }
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    [Parameter]
    public EventCallback<string> OnFranchiseCreated { get; set; }

    [Inject]
    public ICoffeeTunesApi Api { get; set; } = default!;

    private string franchiseName = string.Empty;
    private bool isSubmitting = false;
    private string? errorMessage;

    private async Task HandleSubmit()
    {
        if (string.IsNullOrWhiteSpace(franchiseName))
        {
            return;
        }

        isSubmitting = true;
        errorMessage = null;

        try
        {
            var contract = new CreateFranchiseContract
            {
                Name = franchiseName.Trim()
            };

            var response = await Api.CreateFranchise(contract);
            
            if (response.IsSuccessStatusCode)
            {
                await OnFranchiseCreated.InvokeAsync(franchiseName);
                ResetForm();
                await OnClose.InvokeAsync();
            }
            else
            {
                var statusCode = (int)response.StatusCode;
                errorMessage = statusCode switch
                {
                    400 => "Invalid franchise name. Please check your input and try again.",
                    401 or 403 => "You don't have permission to create a franchise.",
                    409 => "A franchise with this name already exists.",
                    _ => $"Failed to create franchise (Error {statusCode}). Please try again."
                };
            }
        }
        catch (HttpRequestException)
        {
            errorMessage = "Unable to connect to the server. Please check your connection and try again.";
        }
        catch (Exception ex)
        {
            errorMessage = "An unexpected error occurred. Please try again.";
            await Console.Error.WriteLineAsync($"Error creating franchise: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void Close()
    {
        ResetForm();
        OnClose.InvokeAsync();
    }

    private void OnBackdropClick()
    {
        if (!isSubmitting)
        {
            Close();
        }
    }

    private void ResetForm()
    {
        franchiseName = string.Empty;
        errorMessage = null;
        isSubmitting = false;
    }
}
