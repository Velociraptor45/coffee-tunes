@page "/franchises"
@using CoffeeTunes.Contracts
@using CoffeeTunes.Contracts.Franchise

<PageTitle>Coffee Tunes - My Franchises</PageTitle>

<AuthorizeView Policy="User">
    <Authorized>
        <div class="franchises-container">
            <div class="franchises-header">
                <h1 class="franchises-title">‚òï My Coffee Franchises</h1>
                <p class="franchises-subtitle">Choose your favorite spot to share tunes</p>
                @if (!isLoading)
                {
                    <div class="button-group">
                        <button class="join-franchise-button" @onclick="OpenJoinModal">
                            <span class="button-icon">üö™</span>
                            <span>Join Franchise</span>
                        </button>
                        <button class="create-franchise-button" @onclick="OpenCreateModal">
                            <span class="button-icon">‚ûï</span>
                            <span>Create New Franchise</span>
                        </button>
                    </div>
                }
            </div>

            @if (isLoading)
            {
                <div class="loading-container">
                    <div class="coffee-loader">‚òï</div>
                    <p>Brewing your franchises...</p>
                </div>
            }
            else if (errorMessage != null)
            {
                <div class="error-state">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <h2>Oops! Something went wrong</h2>
                    <p>@errorMessage</p>
                    <button class="retry-button" @onclick="LoadFranchises">Try Again</button>
                </div>
            }
            else if (franchises == null || !franchises.Any())
            {
                <div class="empty-state">
                    <div class="empty-icon">üéµ</div>
                    <h2>No Franchises Yet</h2>
                    <p>You're not part of any coffee franchise yet. Time to create one!</p>
                </div>
            }
            else
            {
                <div class="franchises-grid">
                    @foreach (var franchise in franchises)
                    {
                        <div class="franchise-card" @onclick="() => NavigateToFranchise(franchise.Id)">
                            <div class="franchise-icon">üè™</div>
                            <h3 class="franchise-name">@franchise.Name</h3>
                            <div class="franchise-arrow">‚Üí</div>
                        </div>
                    }
                </div>
            }
        </div>

        <CreateFranchiseModal 
            IsVisible="showCreateModal" 
            OnClose="CloseCreateModal" 
            OnFranchiseCreated="OnFranchiseCreated" />
        
        <JoinFranchiseModal 
            IsVisible="showJoinModal" 
            OnClose="CloseJoinModal" 
            OnFranchiseJoined="OnFranchiseJoined" />
    </Authorized>
    <NotAuthorized>
        <RedirectToLogin />
    </NotAuthorized>
</AuthorizeView>

@code {
    [Inject]
    public ICoffeeTunesApi Api { get; set; } = default!;

    [Inject]
    public NavigationManager Navigation { get; set; } = default!;

    private List<FranchiseOverviewContract>? franchises;
    private bool isLoading = true;
    private string? errorMessage;
    private bool showCreateModal = false;
    private bool showJoinModal = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadFranchises();
    }

    private async Task LoadFranchises()
    {
        isLoading = true;
        errorMessage = null;
        
        try
        {
            franchises = await Api.GetAllFranchises();
        }
        catch (Exception)
        {
            errorMessage = "Unable to load franchises. Please try again later.";
            franchises = null;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void NavigateToFranchise(Guid franchiseId)
    {
        Navigation.NavigateTo($"/franchise/{franchiseId}");
    }

    private void OpenCreateModal()
    {
        showCreateModal = true;
    }

    private void CloseCreateModal()
    {
        showCreateModal = false;
    }

    private void OpenJoinModal()
    {
        showJoinModal = true;
    }

    private void CloseJoinModal()
    {
        showJoinModal = false;
    }

    private async Task OnFranchiseCreated(string franchiseName)
    {
        // Reload the franchises list to show the newly created franchise
        await LoadFranchises();
    }

    private async Task OnFranchiseJoined(string franchiseName)
    {
        // Reload the franchises list to show the newly joined franchise
        await LoadFranchises();
    }
}
