@page "/franchise/{franchiseId:guid}/bar/{barId:guid}"
@using Microsoft.AspNetCore.Components.Authorization
@using CoffeeTunes.Contracts
@using CoffeeTunes.Contracts.Bars
@using CoffeeTunes.Contracts.Ingredients
@using CoffeeTunes.Frontend.Components.BarDetails

<PageTitle>Coffee Tunes - @(bar?.Topic ?? "Bar")</PageTitle>

<AuthorizeView Policy="User">
    <Authorized>
        <div class="bar-details-container">
            @if (isLoading)
            {
                <div class="loading-container">
                    <div class="coffee-loader">☕</div>
                    <p>Brewing your bar...</p>
                </div>
            }
            else if (errorMessage != null)
            {
                <div class="error-state">
                    <div class="error-icon">⚠️</div>
                    <h2>Oops! Something went wrong</h2>
                    <p>@errorMessage</p>
                    <button class="retry-button" @onclick="LoadBarData">Try Again</button>
                </div>
            }
            else if (bar != null)
            {
                <BarHeader Bar="@bar" OnBackClick="@NavigateBack" />

                <ViewSwitcher ActiveView="@activeView" OnViewChange="@SwitchView" />

                <div class="view-content">
                    @if (activeView == ViewSwitcher.ViewBrewing)
                    {
                        <BrewingView />
                    }
                    else if (activeView == ViewSwitcher.ViewIngredients)
                    {
                        <IngredientsView 
                            Bar="@bar"
                            FranchiseId="@FranchiseId"
                            Ingredients="@ingredients"
                            IsLoading="@isLoadingIngredients"
                            ErrorMessage="@ingredientsErrorMessage"
                            OnRetry="@LoadIngredients"
                            OnIngredientAdded="@HandleIngredientAdded" />
                    }
                    else if (activeView == ViewSwitcher.ViewStats)
                    {
                        <StatsView />
                    }
                </div>
            }
        </div>
    </Authorized>
    <NotAuthorized>
        <RedirectToLogin />
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter]
    public Guid FranchiseId { get; set; }

    [Parameter]
    public Guid BarId { get; set; }

    [Inject]
    public ICoffeeTunesApi Api { get; set; } = default!;

    [Inject]
    public NavigationManager Navigation { get; set; } = default!;

    private BarContract? bar;
    private List<IngredientContract> ingredients = new();
    private bool isLoading = true;
    private bool isLoadingIngredients = false;
    private string? errorMessage;
    private string? ingredientsErrorMessage;
    private string activeView = ViewSwitcher.ViewBrewing;
    private Guid? previousBarId;

    protected override async Task OnInitializedAsync()
    {
        previousBarId = BarId;
        await LoadBarData();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Reload data only when BarId changes
        if (previousBarId != BarId)
        {
            previousBarId = BarId;
            await LoadBarData();
        }
    }

    private async Task LoadBarData()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            bar = await Api.GetBar(FranchiseId, BarId);
            
            // Load ingredients if we're on the ingredients view
            if (activeView == ViewSwitcher.ViewIngredients)
            {
                await LoadIngredients();
            }
        }
        catch (HttpRequestException)
        {
            errorMessage = "Unable to connect to the server. Please check your connection and try again.";
            bar = null;
        }
        catch (Exception ex)
        {
            errorMessage = "Unable to load bar details. Please try again later.";
            bar = null;
            Console.Error.WriteLine($"Error loading bar data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadIngredients()
    {
        isLoadingIngredients = true;
        ingredientsErrorMessage = null;

        try
        {
            ingredients = await Api.GetIngredients(FranchiseId, BarId);
        }
        catch (HttpRequestException)
        {
            ingredientsErrorMessage = "Unable to connect to the server. Please check your connection and try again.";
            ingredients = new();
        }
        catch (Exception ex)
        {
            ingredientsErrorMessage = "Unable to load ingredients. Please try again later.";
            ingredients = new();
            Console.Error.WriteLine($"Error loading ingredients: {ex.Message}");
        }
        finally
        {
            isLoadingIngredients = false;
        }
    }

    private async Task SwitchView(string view)
    {
        activeView = view;
        
        // Load ingredients when switching to ingredients view
        if (view == ViewSwitcher.ViewIngredients && !isLoadingIngredients && !ingredients.Any() && ingredientsErrorMessage == null)
        {
            await LoadIngredients();
        }
    }

    private async Task HandleIngredientAdded()
    {
        await LoadIngredients();
    }

    private void NavigateBack()
    {
        Navigation.NavigateTo($"/franchise/{FranchiseId}");
    }
}
