@page "/franchise/{franchiseId:guid}/bar/{barId:guid}"
@using Microsoft.AspNetCore.Components.Authorization
@using CoffeeTunes.Contracts
@using CoffeeTunes.Contracts.Bars
@using CoffeeTunes.Contracts.Beans
@using CoffeeTunes.Contracts.BrewCycles
@using CoffeeTunes.Contracts.Ingredients
@using CoffeeTunes.Frontend.Components.BarDetails
@using CoffeeTunes.Frontend.Services
@implements IAsyncDisposable

<PageTitle>Coffee Tunes - @(bar?.Topic ?? "Bar")</PageTitle>

<AuthorizeView Policy="User">
    <Authorized>
        <div class="bar-details-container">
            @if (isLoading)
            {
                <div class="loading-container">
                    <div class="coffee-loader">☕</div>
                    <p>Brewing your bar...</p>
                </div>
            }
            else if (errorMessage != null)
            {
                <div class="error-state">
                    <div class="error-icon">⚠️</div>
                    <h2>Oops! Something went wrong</h2>
                    <p>@errorMessage</p>
                    <button class="retry-button" @onclick="LoadBarData">Try Again</button>
                </div>
            }
            else if (bar != null)
            {
                <BarHeader Bar="@bar" OnBackClick="@NavigateBack" />

                <ViewSwitcher ActiveView="@activeView" OnViewChange="@SwitchView" />

                <div class="view-content">
                    @if (activeView == ViewSwitcher.ViewBrewing)
                    {
                        <BrewingView 
                            Bar="@bar" 
                            FranchiseId="@FranchiseId"
                            BarId="@BarId"
                            BrewCycle="@currentBrewCycle"
                            VotedHipsters="@votedHipsters"
                            OnBrewCycleStarted="@HandleBrewCycleStarted" />
                    }
                    else if (activeView == ViewSwitcher.ViewIngredients)
                    {
                        <IngredientsView 
                            Bar="@bar"
                            FranchiseId="@FranchiseId"
                            Ingredients="@ingredients"
                            IsLoading="@isLoadingIngredients"
                            ErrorMessage="@ingredientsErrorMessage"
                            OnRetry="@LoadIngredients"
                            OnIngredientAdded="@HandleIngredientAdded" />
                    }
                    else if (activeView == ViewSwitcher.ViewStats)
                    {
                        <StatsView />
                    }
                </div>
            }
        </div>
    </Authorized>
    <NotAuthorized>
        <RedirectToLogin />
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter]
    public Guid FranchiseId { get; set; }

    [Parameter]
    public Guid BarId { get; set; }

    [Inject]
    public ICoffeeTunesApi Api { get; set; } = default!;

    [Inject]
    public NavigationManager Navigation { get; set; } = default!;

    [Inject]
    public BarHubService HubService { get; set; } = default!;

    private BarContract? bar;
    private List<IngredientContract> ingredients = new();
    private BrewCycleContract? currentBrewCycle;
    private bool isLoading = true;
    private bool isLoadingIngredients = false;
    private string? errorMessage;
    private string? ingredientsErrorMessage;
    private string activeView = ViewSwitcher.ViewBrewing;
    private Guid? previousBarId;
    private HashSet<Guid> votedHipsterIds = new();
    private List<ContributingHipsterContract> votedHipsters = new();

    protected override async Task OnInitializedAsync()
    {
        previousBarId = BarId;
        
        // Set up SignalR event handlers
        HubService.OnBarUpdated += HandleBarUpdated;
        HubService.OnBrewCycleUpdated += HandleBrewCycleUpdated;
        HubService.OnBeanCast += HandleBeanCast;
        
        await LoadBarData();
        
        // Connect to SignalR hub and join the bar
        try
        {
            await HubService.ConnectAsync();
            await HubService.JoinBarAsync(BarId);
        }
        catch (Exception ex)
        {
            await Console.Error.WriteLineAsync($"Error connecting to SignalR hub: {ex.Message}");
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // Reload data only when BarId changes
        if (previousBarId != BarId)
        {
            // Leave the previous bar
            if (previousBarId.HasValue)
            {
                try
                {
                    await HubService.LeaveBarAsync(previousBarId.Value);
                }
                catch (Exception ex)
                {
                    await Console.Error.WriteLineAsync($"Error leaving bar: {ex.Message}");
                }
            }
            
            previousBarId = BarId;
            await LoadBarData();
            
            // Join the new bar
            try
            {
                await HubService.JoinBarAsync(BarId);
            }
            catch (Exception ex)
            {
                await Console.Error.WriteLineAsync($"Error joining bar: {ex.Message}");
            }
        }
    }

    private async Task LoadBarData()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            bar = await Api.GetBar(FranchiseId, BarId);
            
            // Load ingredients if we're on the ingredients view
            if (activeView == ViewSwitcher.ViewIngredients)
            {
                await LoadIngredients();
            }
        }
        catch (HttpRequestException)
        {
            errorMessage = "Unable to connect to the server. Please check your connection and try again.";
            bar = null;
        }
        catch (Exception ex)
        {
            errorMessage = "Unable to load bar details. Please try again later.";
            bar = null;
            await Console.Error.WriteLineAsync($"Error loading bar data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadIngredients()
    {
        isLoadingIngredients = true;
        ingredientsErrorMessage = null;

        try
        {
            ingredients = await Api.GetIngredients(FranchiseId, BarId);
        }
        catch (HttpRequestException)
        {
            ingredientsErrorMessage = "Unable to connect to the server. Please check your connection and try again.";
            ingredients = new();
        }
        catch (Exception ex)
        {
            ingredientsErrorMessage = "Unable to load ingredients. Please try again later.";
            ingredients = new();
            await Console.Error.WriteLineAsync($"Error loading ingredients: {ex.Message}");
        }
        finally
        {
            isLoadingIngredients = false;
        }
    }

    private async Task SwitchView(string view)
    {
        activeView = view;
        
        // Load ingredients when switching to ingredients view
        if (view == ViewSwitcher.ViewIngredients && !isLoadingIngredients && !ingredients.Any() && ingredientsErrorMessage == null)
        {
            await LoadIngredients();
        }
    }

    private async Task HandleIngredientAdded()
    {
        await LoadIngredients();
    }

    private void NavigateBack()
    {
        Navigation.NavigateTo($"/franchise/{FranchiseId}");
    }
    
    private Task HandleBarUpdated(BarContract updatedBar)
    {
        if (updatedBar.Id == BarId)
        {
            bar = updatedBar;
            StateHasChanged();
        }
        return Task.CompletedTask;
    }
    
    private Task HandleBrewCycleUpdated(BrewCycleContract brewCycle)
    {
        currentBrewCycle = brewCycle;
        ResetVotingState();
        StateHasChanged();
        return Task.CompletedTask;
    }
    
    private Task HandleBeanCast(BeanCastContract beanCast)
    {
        votedHipsterIds.Add(beanCast.HipsterId);
        UpdateVotedHipstersList();
        StateHasChanged();
        return Task.CompletedTask;
    }
    
    private void ResetVotingState()
    {
        votedHipsterIds.Clear();
        UpdateVotedHipstersList();
    }
    
    private void UpdateVotedHipstersList()
    {
        if (bar != null)
        {
            votedHipsters = bar.ContributingHipsters
                .Where(h => votedHipsterIds.Contains(h.Id))
                .ToList();
        }
    }
    
    private Task HandleBrewCycleStarted()
    {
        // This will be handled by SignalR updates
        return Task.CompletedTask;
    }
    
    public async ValueTask DisposeAsync()
    {
        // Unsubscribe from events
        HubService.OnBarUpdated -= HandleBarUpdated;
        HubService.OnBrewCycleUpdated -= HandleBrewCycleUpdated;
        HubService.OnBeanCast -= HandleBeanCast;
        
        // Leave the bar
        try
        {
            await HubService.LeaveBarAsync(BarId);
        }
        catch (Exception ex)
        {
            await Console.Error.WriteLineAsync($"Error leaving bar on dispose: {ex.Message}");
        }
    }
}
